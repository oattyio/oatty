workflow: postgres_nextgen_pool_create
description: "Create and activate a Next-Gen Heroku Postgres compute pool, then wait for it to become available."
inputs:
  app:
    provider: apps list
    select: { value_field: name, display_field: name }
  addon:
    description: "Heroku Postgres addon name or ID (Next-Gen performance tier)."
    provider: apps addons:list
    depends_on:
      app: ${{ inputs.app }}
    select: { value_field: name, display_field: name }
  pool_name:
    description: "Unique name for the new compute pool (e.g., writer-east)."
    type: string
  instance_count:
    description: "Number of compute instances to provision in the pool."
    type: integer
    enum: [1, 2, 3]
  performance_level:
    description: "Performance level for the pool (e.g., 32G-Performance). Use the lookup step below if unsure."
    provider:
      id: data postgres:levels:info
      field: levels
    provider_args: { tier: performance }
    select: { value_field: name, display_field: name }
    default:
      from: literal
      value: "32G-Performance"
steps:
  - id: list_levels
    description: "Optional reference â€” lists supported performance levels for the performance tier."
    run: data postgres:levels:info
    with:
      tier: performance

  - id: create_pool
    run: data postgres:pools:create
    with:
      addon: ${{ inputs.addon }}
    body:
      name: ${{ inputs.pool_name }}
      count: ${{ inputs.instance_count }}
      level: ${{ inputs.performance_level }}

  - id: wait_for_pool
    description: "Poll until the new pool reports status=available."
    run: data postgres:pools:info
    with:
      addon: ${{ inputs.addon }}
      uuid: ${{ steps.create_pool.output.uuid }}
    repeat:
      every: 20s
      until: ${{ step.output.status == "available" }}
