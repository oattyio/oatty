workflow: pipeline_setup_and_promote
title: "Pipeline Setup and Promote"
description: "Create a staging/production pipeline, associate apps, and promote from staging to production."
inputs:
  pipeline_name:
    description: "Name for the pipeline"
    type: string
  staging_app:
    description: "Name for the staging app to create"
    type: string
  production_app:
    description: "Name for the production app to create"
    type: string
  region:
    provider: regions list
    select: { value_field: name, display_field: name }
    default:
      from: literal
      value: "us"
steps:
  - id: create_staging
    run: apps create
    body:
      name: ${{ inputs.staging_app }}
      region: ${{ inputs.region }}

  - id: create_production
    run: apps create
    body:
      name: ${{ inputs.production_app }}
      region: ${{ inputs.region }}

  - id: create_pipeline
    run: pipelines create
    body:
      name: ${{ inputs.pipeline_name }}

  - id: add_staging
    run: pipelines add
    body:
      app: ${{ inputs.staging_app }}
      pipeline: ${{ steps.create_pipeline.output.id }}
      stage: staging

  - id: add_production
    run: pipelines add
    body:
      app: ${{ inputs.production_app }}
      pipeline: ${{ steps.create_pipeline.output.id }}
      stage: production

  - id: promote
    description: "Promote latest slug from staging to production"
    run: pipelines promote
    with:
      app: ${{ inputs.staging_app }}
