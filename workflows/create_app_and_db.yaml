workflow: app_with_db
title: "Create app with DB"
description: "Create an app, provision Postgres, and seed config."
inputs:
  app_name:
    description: "Name for the application"
    type: string
    validate:
      pattern: "^[a-z](?:[a-z0-9-]{1,28}[a-z0-9])$"
  region:
    provider: regions list
    select:
      value_field: name
      display_field: name
    default:
      from: literal
      value: "us"
  addon_plan:
    description: "Heroku Postgres plan"
    provider:
      id: addon-services plans:list
    provider_args: { add_on_service: heroku-postgresql }
    select:
      value_field: name
      display_field: name
steps:
  - id: create_app
    run: apps create
    body:
      name: ${{ inputs.app_name }}
      region: ${{ inputs.region }}

  - id: add_pg
    run: apps addons:create
    with:
      app: ${{ inputs.app_name }}
    body:
      plan: ${{ inputs.addon_plan }}

  - id: set_config
    run: apps config-vars:update
    with:
      app: ${{ inputs.app_name }}
    body:
      RUST_LOG: info
