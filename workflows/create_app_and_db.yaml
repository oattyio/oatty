workflow: app_with_db
title: "Create app with DB"
description: "Create an app, provision Postgres, and seed config."
inputs:
  app_name:
    name: "App Name"
    description: "Name for the application"
    type: string
    validate:
      pattern: "^[a-z](?:[a-z0-9-]{1,28}[a-z0-9])$"
  region:
    name: "Region"
    provider: regions list
    select:
      value_field: name
      display_field: name
    default:
      from: literal
      value: "us"
  addon_plan:
    name: "Postgres plan"
    description: "Oatty Postgres plan"
    provider:
      id: addon-services plans:list
    provider_args: { add_on_service: heroku-postgresql }
    select:
      value_field: name
      display_field: name
steps:
  - id: create_app
    run: apps create
    body:
      name: ${{ inputs.app_name }}
      region: ${{ inputs.region }}

  - id: add_pg
    run: apps addons:create
    with:
      app: ${{ inputs.app_name }}
    body:
      plan: ${{ inputs.addon_plan }}
  - id: wait_for_pg
    run: apps addons:info
    with:
      app: ${{ inputs.app_name }}
      add_on: ${{ steps.add_pg.output.id }}
    repeat:
      until: ${{ steps.wait_for_pg.output.state != "provisioning" }}
      every: 10s
      max_attempts: 50
