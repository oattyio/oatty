workflow: provision_addon
title: "Provision Addon"
description: "Provision an addon for an app, optionally setting config vars"
inputs:
  app_name:
    name: "App Name"
    description: "Name for the new app"
    type: string
    provider: apps list
    select: { value_field: name, display_field: name }
  choose_addon:
    name: "Choose Addon"
    description: "Addon to provision (e.g., heroku-postgresql)"
    provider: addon-services list
    select: { value_field: name, display_field: name }
  choose_plan:
    name: "Addon Plan"
    description: "The plan of the chosen addon (e.g., heroku-postgresql:hobby-dev)"
    provider: addon-services plans:list
    select: { value_field: name, display_field: name }
    provider_args:
      add_on_service: ${{ inputs.choose_addon }}
    depends_on:
      choose_addon: ${{ inputs.choose_addon }}
  config_vars:
    name: "Config Vars"
    description: "Config vars to set on the app"
    type: object
    optional: true
    validate:
      pattern: "^[a-zA-Z0-9](?:[a-z0-9-]{1,28}[a-z0-9])$"
steps:
  - id: provision_addon
    run: apps addons:create
    with:
      app: ${{ inputs.app_name }}
      addon: ${{ inputs.choose_addon }}
      plan: ${{ inputs.addon_plan }}

  - id: set_config
    when: ${{ !!inputs.config_vars }}
    run: apps config-vars:update
    with:
      app: ${{ inputs.app_name }}
    body: ${{ inputs.config_vars }}
    
  - id: wait_for_addon
    run: apps addons:info
    with:
      app: ${{ inputs.app_name }}
      add_on: ${{ steps.provision_addon.output.id }}
    repeat:
      until: ${{ steps.wait_for_addon.output.state != "provisioning" }}
      every: 10s
      max_attempts: 50